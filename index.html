<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Giochi in sede</title>
  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
  <style>
    /* LOGICA */
    #messaggio-errore {
      position: fixed;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      display: none;
    }
    .clickable-row {
      cursor: pointer;
    }
    .clickable-row:hover {
      background-color: #e9ecef;
    }
    /* Rimuove il bordo superiore per la tabella interna così sembra un dettaglio */
    .detail-row table {
      border-top: none;
    }

    /* STILE */
    .fascia-eta {
      font-weight: bold;
      font-size: 1.1em;
    }
    .img-small-box{
      width: 1%; white-space: nowrap; vertical-align: middle;
    }
  </style>
</head>
<body class="container py-4">
  <!-- Aggiungi questa parte dentro <body> prima del titolo -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h2>🎲 Giochi in sede</h2>
    <div>
      <span id="stato-api" title="Stato API">⚪</span>
    </div>
  </div>

  <div id="messaggio-errore" class="alert alert-danger"></div>

  <div class="row g-2 mb-4">
    <div class="col-md-4"><input id="nome" class="form-control" placeholder="Nome" /></div>
    <div class="col-md-4"><input id="proprietario" class="form-control" placeholder="Proprietario" /></div>
    <div class="col-md-4"><input id="tag" class="form-control" placeholder="TagTipologia" /></div>
    <div class="col-12">
      <button onclick="aggiungi()" class="btn btn-primary mt-2">Aggiungi</button>
    </div>
  </div>

  <div class="mb-3">
    <input id="filtro" class="form-control" placeholder="🔍 Cerca..." oninput="filtra()" />
  </div>

  <table class="table table-striped">
  <thead class="table-dark">
    <tr>
      <th>Titolo</th>
      <th>Autore</th>
      <th>Difficolta</th>
      <th colspan="3" class="tag-header">Tag</th>
    </tr>
  </thead>
  <tbody id="tabella-body"></tbody>
</table>

  <script>

    console.log("v01: caricata 09/05/2025 21:16");
    const API_URL = "https://script.google.com/macros/s/AKfycbygmykV1SAIWmnG43mL4dEBpj2PEfkijlmCsDGBiAQ0loGfQ_iHRkB6AaQ_E3NC---JSg/exec";
    let dati = [];
    caricaDati();
    controllaStatoAPI(); // <-- aggiunto


    async function controllaStatoAPI() {
      const stato = document.getElementById("stato-api");
      try {
        const res = await fetch(API_URL + "?version=true");
        if (!res.ok) throw new Error("Errore");
        const data = await res.json();
        if (data.version) {
          stato.textContent = "🟢";
          stato.title = `API OK - Versione ${data.version}`;
        } else {
          throw new Error("Formato inatteso");
        }
      } catch (e) {
        stato.textContent = "🔴";
        stato.title = "Errore nel contattare l'API";
      }
    }

    function mostraMessaggioErrore(testo) {
      const msg = document.getElementById("messaggio-errore");
      msg.textContent = testo;
      msg.style.display = "block";
      setTimeout(() => msg.style.display = "none", 5000);
    }

    /**
     * @description: carica i dati all'accesso
     * 
     * */
    async function caricaDati() {
      try {
        const res = await fetch(API_URL);
        if (!res.ok) throw new Error("Errore risposta");
        dati = await res.json();
        dati = dati.map((r, i) => ({ ...r, riga: i + 2 }));
        mostra(dati);
      } catch (error) {
        console.error("Errore durante il caricamento dati:", error);
        mostraMessaggioErrore("Errore: impossibile contattare il server. Riprova più tardi.");
      }
    }

    function mostra(lista) {
      const tbody = document.getElementById("tabella-body");
      tbody.innerHTML = "";

      lista.forEach(r => {
        // Riga principale
        const trMain = document.createElement("tr");
        trMain.classList.add("clickable-row");
        trMain.innerHTML = `
          <td>${r.Titolo}</td>
          <td>${r.Autore}</td>
          <td>${r.Difficolta}</td>
          <td class="pe-0 img-small-box">${r.Consigliato ? '<img src="icons/certified-icon-small.ico" alt="Consigliato" />' : ''}</td>
          <td class="ps-0 pe-0 img-small-box">${r.Esplicito ? '<img src="icons/pegi-18-small.png" alt="Esplicito" width="48px" />' : ''}</td>
          <td class="ps-0 img-small-box">${r.FasciaEta ? '<span class="fascia-eta" title="Fascia di età">' + r.FasciaEta + '+</span>' : ''}</td>
        `;
        tbody.appendChild(trMain);

        // Riga dettaglio nascosta con tabella interna
        const trDetail = document.createElement("tr");
        trDetail.classList.add("detail-row");
        trDetail.style.display = "none";
        trDetail.innerHTML = `
          <td colspan="6" style="background:#f8f9fa; padding: 0;">
            <table class="table mb-0" style="margin: 0;">
              <thead class="table-light">
                <tr>
                  <th>Proprietario</th>
                  <th>Note</th>
                  <th>Tipologia</th>
                  <th>Modifica</th>
                  <th>Elimina</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td>${r.Proprietario || '-'}</td>
                  <td>${r.Note || '-'}</td>
                  <td>${r.Tipologia || '-'}</td>
                  <td><button class="btn btn-sm btn-warning" onclick="modifica('${r.Id}')">Modifica</button></td>
                  <td><button class="btn btn-sm btn-danger" onclick="elimina('${r.Id}')">Elimina</button></td>
                </tr>
              </tbody>
            </table>
          </td>
        `;
        tbody.appendChild(trDetail);

        // Toggle dettaglio
        trMain.addEventListener("click", () => {
          trDetail.style.display = trDetail.style.display === "none" ? "table-row" : "none";
        });
      });
    }

    /**
     * @description: Filtra i dati in base a una parola generica
     * 
     * */
    function filtra() {
      const q = document.getElementById("filtro").value.toLowerCase().trim();

      if (!q) {
        mostra(dati); // Se il campo è vuoto, mostra tutti
        return;
      }

      const queryParts = q.split(',').map(s => s.trim()).filter(Boolean);

      const filtrati = dati.filter(r =>
        queryParts.every(part =>
          r.Titolo?.toLowerCase().includes(part) ||
          r.Tipologia?.toLowerCase().includes(part) ||
          r.Autore?.toLowerCase().includes(part) ||
          r.Proprietario?.toLowerCase().includes(part) ||
          r.Difficolta?.toLowerCase().includes(part) ||
          r.Note?.toLowerCase().includes(part) ||
          r.FasciaEta?.toString().includes(part) || 
          (r.Esplicito ? ('18+'.includes(part) || 'esplicito'.includes(part)) : ''.includes(part)) ||
          (r.Consigliato ? 'consigliato'.includes(part) : ''.includes(part))
        )
      );

      mostra(filtrati);
    }

    async function aggiungi() {
    const params = new URLSearchParams({
      action: "AggiungiNuovo",
      Nome: document.getElementById("nome").value,
      Proprietario: document.getElementById("proprietario").value,
      TagTipologia: document.getElementById("tag").value
    });

    try {
      const res = await fetch(API_URL + "?" + params.toString());
      const data = await res.json();
      console.log("Risposta:", data);
      if (data.success) caricaDati();
    } catch (error) {
      console.error("Errore:", error);
      mostraMessaggioErrore("Errore durante l'aggiunta del gioco.");
    }
  }




    async function elimina(riga) {
      if (!confirm("Sei sicuro di voler eliminare questa riga?")) return;
      try {
        await fetch(`${API_URL}?riga=${riga}`, { method: "DELETE" });
        caricaDati();
      } catch (error) {
        mostraMessaggioErrore("Errore durante l'eliminazione.");
      }
    }

    async function modifica(riga, nome, proprietario, tag) {
      const nuovoNome = prompt("Modifica Nome", nome);
      const nuovoProprietario = prompt("Modifica Proprietario", proprietario);
      const nuovoTag = prompt("Modifica TagTipologia", tag);
      if (nuovoNome && nuovoProprietario && nuovoTag) {
        const aggiornato = {
          Nome: nuovoNome,
          Proprietario: nuovoProprietario,
          TagTipologia: nuovoTag
        };
        try {
          await fetch(`${API_URL}?riga=${riga}`, {
            method: "PUT",
            body: JSON.stringify(aggiornato)
          });
          caricaDati();
        } catch (error) {
          mostraMessaggioErrore("Errore durante la modifica.");
        }
      }
    }

    caricaDati();
  </script>
  <a target="_blank" href="https://icons8.com/icon/PuZNs3i0Mud1/pegi-18">Pegi 18</a> icon by <a target="_blank" href="https://icons8.com">Icons8</a>
  <a target="_blank" href="https://icon-icons.com/it/icona/dati-carta-cartella-documento-certificato-premium-qualit%C3%A0/225527">Pegi 18</a> icon by <a target="_blank" href="https://icon-icons.com">icon-icons</a>
</body>
</html>
